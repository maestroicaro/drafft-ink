<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrafftInk</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        
        #app {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #loading {
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 18px;
            text-align: center;
        }
        
        #loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        canvas {
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading">
            <div class="spinner"></div>
            <div id="loading-text">Loading DrafftInk...</div>
            <div id="loading-progress" style="font-size: 14px; color: #888; margin-top: 8px;"></div>
        </div>
    </div>
    
    <script>
        // Prevent browser from intercepting keyboard shortcuts we need
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (
                e.key === 'e' || e.key === 'E' ||
                e.key === 's' || e.key === 'S' ||
                e.key === 'g' || e.key === 'G'
            )) {
                e.preventDefault();
            }
        });
    </script>
    <script type="module">
        import init from './pkg/drafftink_app.js';
        
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        async function run() {
            const loadingText = document.getElementById('loading-text');
            const loadingProgress = document.getElementById('loading-progress');
            
            try {
                // Fetch WASM with progress
                const wasmPath = './pkg/drafftink_app_bg.wasm';
                const response = await fetch(wasmPath);
                const contentLength = response.headers.get('Content-Length');
                const total = parseInt(contentLength, 10) || 0;
                
                let loaded = 0;
                const reader = response.body.getReader();
                const chunks = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    
                    if (total > 0) {
                        const percent = Math.min(100, Math.round((loaded / total) * 100));
                        loadingProgress.textContent = `${percent}%`;
                    } else {
                        loadingProgress.textContent = formatBytes(loaded);
                    }
                }
                
                // Combine chunks into single array
                const wasmBytes = new Uint8Array(loaded);
                let offset = 0;
                for (const chunk of chunks) {
                    wasmBytes.set(chunk, offset);
                    offset += chunk.length;
                }
                
                loadingText.textContent = 'Initializing...';
                loadingProgress.textContent = '';
                
                // Initialize with the fetched WASM bytes
                await init(wasmBytes);
                
                // Remove loading indicator
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.remove();
                }
            } catch (error) {
                console.error('Failed to load DrafftInk:', error);
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = `
                        <div style="color: #ef4444;">Failed to load DrafftInk</div>
                        <div style="font-size: 14px; margin-top: 8px; color: #888;">
                            ${error.message || 'Unknown error'}
                        </div>
                        <div style="font-size: 12px; margin-top: 16px; color: #666;">
                            Make sure your browser supports WebGPU.
                        </div>
                    `;
                }
            }
        }
        
        run();
    </script>
</body>
</html>
