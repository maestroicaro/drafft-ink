# Build stage - Compile Rust to WASM
FROM rust:bookworm as builder

# Install wasm-pack and dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    build-essential \
    cmake \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install wasm-pack
RUN curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

WORKDIR /app

# Copy the project
COPY . .

# Build the WASM app
RUN chmod +x build.sh && ./build.sh --wasm

# Runtime stage - Serve static files
FROM nginx:alpine

# Copy built WASM files and static assets
COPY --from=builder /app/web/index.html /usr/share/nginx/html/
COPY --from=builder /app/web/pkg /usr/share/nginx/html/pkg
COPY --from=builder /app/web/*.js /usr/share/nginx/html/
COPY --from=builder /app/web/*.css /usr/share/nginx/html/ 2>/dev/null || true

# Expose port 80
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
